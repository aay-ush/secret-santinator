{% extends "base.html" %}
{% block title %}Login Â· Secret Santa{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">
    <div class="glass p-4 p-md-5">
      <h1 class="h3 fw-extrabold mb-2">Welcome back ðŸŽ„</h1>
      <p class="muted mb-4">Log in using your saved passphrase on this device, or type one manually (e.g., a temporary passphrase from admin).</p>

      <form id="login-form" method="post" class="vstack gap-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div>
          <label for="login-name" class="form-label">Name</label>
          <input class="form-control" type="text" name="name" id="login-name" placeholder="e.g. Alice" required>
        </div>

        <div class="pt-1">
          <div class="d-flex justify-content-between align-items-center">
            <label for="login-passphrase" class="form-label mb-1">Passphrase</label>
            <span class="muted small">Leave blank to use saved</span>
          </div>
          <input class="form-control" type="password" id="login-passphrase" autocomplete="current-password"
                 placeholder="(optional)">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="login-show">
            <label class="form-check-label muted" for="login-show">Show passphrase</label>
          </div>
          <div class="form-check mt-1">
            <input class="form-check-input" type="checkbox" id="login-remember" checked>
            <label class="form-check-label muted" for="login-remember">Remember on this device</label>
          </div>
        </div>

        <input type="hidden" name="client_hash" id="login-client-hash">

        <button class="btn btn-primary btn-lg w-100" type="submit">Login</button>
        <p id="login-status" class="muted small mb-0"></p>
      </form>

      <hr class="my-4" style="border-color: rgba(255,255,255,.14);">

      <h2 class="h6 fw-bold mb-2">Lost your passphrase?</h2>
      <p class="muted mb-3">Request reset from admin</p>

      <form id="reset-form" method="post" action="{{ url_for('auth.request_reset') }}" class="vstack gap-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div>
          <label for="reset-name" class="form-label">Name</label>
          <input class="form-control" type="text" name="name" id="reset-name" placeholder="forgetful santa's name" required>
        </div>
        <button class="btn btn-outline-light" type="submit" id="reset-btn" disabled>
          Request reset
        </button>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const loginForm = document.getElementById("login-form");
  const loginName = document.getElementById("login-name");
  const loginHash = document.getElementById("login-client-hash");
  const statusEl = document.getElementById("login-status");

  const passInput = document.getElementById("login-passphrase");
  const showPass = document.getElementById("login-show");
  const remember = document.getElementById("login-remember");

  const resetName = document.getElementById("reset-name");
  const resetBtn  = document.getElementById("reset-btn");

  function syncNames() {
    const v = loginName.value.trim();
    resetName.value = v;
    resetBtn.disabled = !v;
  }

  loginName.addEventListener("input", syncNames);
  resetName.addEventListener("input", () => {
    resetBtn.disabled = !resetName.value.trim();
  });

  showPass.addEventListener("change", () => {
    passInput.type = showPass.checked ? "text" : "password";
  });

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    statusEl.textContent = "";

    const name = loginName.value.trim();
    if (!name) { alert("Name is required."); return; }
    syncNames();

    let phrase = (passInput.value || "").trim();

    // If user didn't type one, use stored passphrase
    if (!phrase) {
      phrase = localStorage.getItem(keyForName(name)) || "";
      if (!phrase) {
        statusEl.textContent =
          "No saved passphrase found on this device. If the organizer gave you a temporary passphrase, type it above. Otherwise request a reset.";
        return;
      }
    }

    if (remember.checked) {
      localStorage.setItem(keyForName(name), phrase);
    } else {
      localStorage.removeItem(keyForName(name));
    }

    loginHash.value = await sha256Hex(phrase);
    e.target.submit();
  });

  syncNames();
})();
</script>
{% endblock %}

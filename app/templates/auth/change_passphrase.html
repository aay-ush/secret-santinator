{% extends "base.html" %}
{% block title %}Change passphrase Â· Secret Santa{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-9 col-lg-7">
    <div class="glass p-4 p-md-5">
      <h1 class="h3 fw-extrabold mb-2">Change passphrase ğŸ”</h1>
      <p class="muted mb-4">
        {% if current_user.must_change_passphrase %}
          You signed in using a temporary passphrase. Please set a new one now.
        {% else %}
          Rotate your passphrase anytime. Your new passphrase can also be saved on this device.
        {% endif %}
      </p>

      <form id="cp-form" method="post" class="vstack gap-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="pt-1">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="phrase_mode" value="generated" id="cp-generated" checked>
            <label class="form-check-label" for="cp-generated">Use generated passphrase</label>
          </div>
          <div class="form-check mt-1">
            <input class="form-check-input" type="radio" name="phrase_mode" value="manual" id="cp-manual">
            <label class="form-check-label" for="cp-manual">Enter passphrase manually</label>
          </div>

          <div id="cp-generated-wrap" class="mt-3">
            <div class="glass p-3 d-flex align-items-center justify-content-between gap-3">
              <div>
                <div class="muted small mb-1">Generated passphrase</div>
                <div id="cp-passphrase" class="fw-bold mono" style="font-size:1.05rem;"></div>
              </div>
              <button class="btn btn-outline-light" type="button" id="cp-new">New</button>
            </div>
          </div>

          <div id="cp-manual-wrap" class="mt-3" style="display:none;">
            <label class="form-label">Passphrase</label>
            <input class="form-control" type="password" id="cp-manual-pass" autocomplete="new-password" placeholder="Type a new passphrase">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="cp-show">
              <label class="form-check-label muted" for="cp-show">Show passphrase</label>
            </div>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="cp-remember" checked>
            <label class="form-check-label muted" for="cp-remember">Remember on this device</label>
          </div>
        </div>

        <input type="hidden" name="client_hash" id="cp-client-hash">

        <button class="btn btn-primary btn-lg w-100" type="submit">Update passphrase</button>

        <div class="muted small">
          Tip: if you use multiple devices, you can keep the same passphrase on each.
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById("cp-form");
  const modeRadios = Array.from(form.querySelectorAll('input[name="phrase_mode"]'));

  const genWrap = document.getElementById("cp-generated-wrap");
  const manWrap = document.getElementById("cp-manual-wrap");

  const phraseBox = document.getElementById("cp-passphrase");
  const btnNew = document.getElementById("cp-new");

  const manualInput = document.getElementById("cp-manual-pass");
  const showManual = document.getElementById("cp-show");
  const remember = document.getElementById("cp-remember");

  const out = document.getElementById("cp-client-hash");

  let currentPhrase = "";

  function refreshPhrase() {
    currentPhrase = generatePassphrase(6);
    phraseBox.textContent = currentPhrase;
  }

  function currentMode(){
    return (modeRadios.find(r => r.checked)?.value) || "generated";
  }

  function syncModeUI(){
    const gen = (currentMode() === "generated");
    genWrap.style.display = gen ? "" : "none";
    manWrap.style.display = gen ? "none" : "";
  }

  btnNew.addEventListener("click", refreshPhrase);
  modeRadios.forEach(r => r.addEventListener("change", syncModeUI));

  showManual.addEventListener("change", () => {
    manualInput.type = showManual.checked ? "text" : "password";
  });

  refreshPhrase();
  syncModeUI();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    let phrase = "";
    if (currentMode() === "manual") {
      phrase = (manualInput.value || "").trim();
      if (!phrase) { alert("Please enter a passphrase."); return; }
    } else {
      phrase = currentPhrase;
    }

    const name = "{{ current_user.name if current_user.is_authenticated else '' }}";
    if (name) {
      if (remember.checked) localStorage.setItem(keyForName(name), phrase);
      else localStorage.removeItem(keyForName(name));
    }

    out.value = await sha256Hex(phrase);
    form.submit();
  });
})();
</script>
{% endblock %}

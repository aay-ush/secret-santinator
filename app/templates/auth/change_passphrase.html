{% extends "base.html" %}
{% block content %}
<div class="card">
  <h1>Change Passphrase</h1>
  <p class="muted">
    Youâ€™re required to change your passphrase now (e.g., you logged in using a temporary one).
    Choose a generated passphrase or type your own.
  </p>

  <form id="change-form" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="form-row">
      <label>Name</label>
      <input class="input" type="text" value="{{ current_user.name }}" disabled>
    </div>

    <hr style="border-color: rgba(255,255,255,0.08); margin: 16px 0;">

    <div class="form-row">
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="radio" name="phrase_mode" value="generated" checked>
        Use generated passphrase
      </label>
      <label style="display:flex; gap:10px; align-items:center; margin-top:8px;">
        <input type="radio" name="phrase_mode" value="manual">
        Enter passphrase manually
      </label>
    </div>

    <!-- Generated -->
    <div id="generated-wrap" style="margin-top:12px;">
      <div id="chg-passphrase"
           style="font-weight:700; font-size:1.1em; padding:10px; background:rgba(255,255,255,0.08); border-radius:10px; display:inline-block;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" type="button" id="btn-new-passphrase">Give me another</button>
      </div>
    </div>

    <!-- Manual -->
    <div id="manual-wrap" style="margin-top:12px; display:none;">
      <div class="form-row">
        <label>Passphrase</label>
        <input class="input" type="password" id="manual-passphrase" autocomplete="new-password"
               placeholder="Type a new passphrase">
      </div>
      <label class="muted" style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" id="show-manual">
        Show passphrase
      </label>
    </div>

    <label class="muted" style="display:flex; gap:10px; align-items:center; margin-top:12px;">
      <input type="checkbox" id="remember-passphrase" checked>
      Remember this passphrase on this device
    </label>

    <input type="hidden" name="client_hash">

    <div style="margin-top:16px;">
      <button class="btn btn-primary" type="submit">Update passphrase</button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("change-form");

  const modeRadios = Array.from(form.querySelectorAll('input[name="phrase_mode"]'));
  const generatedWrap = document.getElementById("generated-wrap");
  const manualWrap = document.getElementById("manual-wrap");

  const phraseBox = document.getElementById("chg-passphrase");
  const regenBtn = document.getElementById("btn-new-passphrase");

  const manualInput = document.getElementById("manual-passphrase");
  const showManual = document.getElementById("show-manual");
  const remember = document.getElementById("remember-passphrase");

  let currentPhrase = "";

  function refreshPhrase() {
    currentPhrase = generatePassphrase(6);
    phraseBox.textContent = currentPhrase;
  }

  function currentMode() {
    return (modeRadios.find(r => r.checked)?.value) || "generated";
  }

  function syncModeUI() {
    const gen = (currentMode() === "generated");
    generatedWrap.style.display = gen ? "" : "none";
    manualWrap.style.display = gen ? "none" : "";
  }

  refreshPhrase();
  syncModeUI();

  regenBtn.addEventListener("click", refreshPhrase);
  modeRadios.forEach(r => r.addEventListener("change", syncModeUI));

  showManual.addEventListener("change", () => {
    manualInput.type = showManual.checked ? "text" : "password";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = "{{ current_user.name }}";

    let phrase = "";
    if (currentMode() === "manual") {
      phrase = (manualInput.value || "").trim();
      if (!phrase) { alert("Please enter a passphrase."); return; }
    } else {
      phrase = currentPhrase;
    }

    if (remember.checked) {
      localStorage.setItem(keyForName(name), phrase);
    } else {
      localStorage.removeItem(keyForName(name));
    }

    form.elements["client_hash"].value = await sha256Hex(phrase);
    form.submit();
  });
});
</script>
{% endblock %}


{% extends "base.html" %}

{% block content %}
<div class="card">
  <h1>Register</h1>

  <form id="register-form" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="form-row">
      <label>Name</label>
      <input class="input" type="text" name="name" required>
    </div>

    {#
    <div class="form-row">
      <label>Email (optional)</label>
      <input class="input" type="email" name="email">
    </div>
    #}

    <hr style="border-color: rgba(255,255,255,0.08); margin: 16px 0;">

    <h2 style="margin-bottom:8px;">Choose your passphrase</h2>
    <p class="muted" style="margin-top:0;">
      You can use a generated one or type your own. Passphrase is stored only on this device (unless you choose not to).
    </p>

    <div class="form-row">
      <label style="display:flex; gap:10px; align-items:center;">
        <input type="radio" name="phrase_mode" value="generated" checked>
        Use generated passphrase
      </label>
      <label style="display:flex; gap:10px; align-items:center; margin-top:8px;">
        <input type="radio" name="phrase_mode" value="manual">
        Enter passphrase manually
      </label>
    </div>

    <!-- Generated -->
    <div id="generated-wrap" style="margin-top:12px;">
      <div id="reg-passphrase"
           style="font-weight:700; font-size:1.1em; padding:10px; background:rgba(255,255,255,0.08); border-radius:10px; display:inline-block;">
      </div>
      <div style="margin-top:10px;">
        <button class="btn" type="button" id="btn-new-passphrase">Give me another</button>
      </div>
    </div>

    <!-- Manual -->
    <div id="manual-wrap" style="margin-top:12px; display:none;">
      <div class="form-row">
        <label>Passphrase</label>
        <input class="input" type="password" id="manual-passphrase" autocomplete="new-password" placeholder="Type a passphrase you will remember">
      </div>
      <label class="muted" style="display:flex; gap:10px; align-items:center;">
        <input type="checkbox" id="show-manual">
        Show passphrase
      </label>
    </div>

    <label class="muted" style="display:flex; gap:10px; align-items:center; margin-top:12px;">
      <input type="checkbox" id="remember-passphrase" checked>
      Remember this passphrase on this device
    </label>

    <input type="hidden" name="client_hash">

    <div style="margin-top:16px;">
      <button class="btn btn-primary" type="submit">Register</button>
    </div>
  </form>

  <p class="muted" style="margin-top:12px;">
    ⚠️ If you clear browser storage or switch devices, you will need to type your passphrase or request a reset.
  </p>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("register-form");

  const modeRadios = Array.from(form.querySelectorAll('input[name="phrase_mode"]'));
  const generatedWrap = document.getElementById("generated-wrap");
  const manualWrap = document.getElementById("manual-wrap");

  const phraseBox = document.getElementById("reg-passphrase");
  const regenBtn = document.getElementById("btn-new-passphrase");

  const manualInput = document.getElementById("manual-passphrase");
  const showManual = document.getElementById("show-manual");
  const remember = document.getElementById("remember-passphrase");

  let currentPhrase = "";

  function refreshPhrase() {
    currentPhrase = generatePassphrase(6);
    phraseBox.textContent = currentPhrase;
  }

  function currentMode() {
    return (modeRadios.find(r => r.checked)?.value) || "generated";
  }

  function syncModeUI() {
    const m = currentMode();
    const gen = (m === "generated");
    generatedWrap.style.display = gen ? "" : "none";
    manualWrap.style.display = gen ? "none" : "";
  }

  // init
  refreshPhrase();
  syncModeUI();

  regenBtn.addEventListener("click", refreshPhrase);
  modeRadios.forEach(r => r.addEventListener("change", syncModeUI));

  showManual.addEventListener("change", () => {
    manualInput.type = showManual.checked ? "text" : "password";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = (form.elements["name"]?.value || "").trim();
    if (!name) { alert("Name is required."); return; }

    let phrase = "";
    if (currentMode() === "manual") {
      phrase = (manualInput.value || "").trim();
      if (!phrase) { alert("Please enter a passphrase."); return; }
    } else {
      phrase = currentPhrase;
    }

    if (remember.checked) {
      localStorage.setItem(keyForName(name), phrase);
    } else {
      localStorage.removeItem(keyForName(name));
    }

    form.elements["client_hash"].value = await sha256Hex(phrase);
    form.submit();
  });
});
</script>
{% endblock %}


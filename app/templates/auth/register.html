{% extends "base.html" %}
{% block title %}Register ¬∑ Secret Santa{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-9 col-lg-7">
    <div class="glass p-4 p-md-5">
      <div class="d-flex align-items-start justify-content-between gap-3">
        <div>
          <h1 class="h3 fw-extrabold mb-2">Join the party üéÅ</h1>
          <p class="muted mb-0">Use a generated passphrase or type your own. Your passphrase can be saved on this device.</p>
        </div>
        <span class="badge badge-soft rounded-pill px-3 py-2">No email required</span>
      </div>

      <form id="register-form" method="post" class="vstack gap-3 mt-4">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div>
          <label class="form-label">Name</label>
          <input class="form-control" type="text" name="name" required>
        </div>

        <div class="pt-2">
          <h2 class="h6 fw-bold mb-2">Choose your passphrase</h2>

          <div class="form-check">
            <input class="form-check-input" type="radio" name="phrase_mode" value="generated" id="mode-generated" checked>
            <label class="form-check-label" for="mode-generated">Use generated passphrase</label>
          </div>
          <div class="form-check mt-1">
            <input class="form-check-input" type="radio" name="phrase_mode" value="manual" id="mode-manual">
            <label class="form-check-label" for="mode-manual">Enter passphrase manually</label>
          </div>

          <!-- Generated -->
          <div id="generated-wrap" class="mt-3">
            <div class="glass p-3 d-flex align-items-center justify-content-between gap-3">
              <div>
                <div class="muted small mb-1">Generated passphrase</div>
                <div id="reg-passphrase" class="fw-bold mono" style="font-size:1.05rem;"></div>
              </div>
              <button class="btn btn-outline-light" type="button" id="btn-new-passphrase">New</button>
            </div>
          </div>

          <!-- Manual -->
          <div id="manual-wrap" class="mt-3" style="display:none;">
            <label class="form-label">Passphrase</label>
            <input class="form-control" type="password" id="manual-passphrase" autocomplete="new-password" placeholder="Type a passphrase you will remember">
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="show-manual">
              <label class="form-check-label muted" for="show-manual">Show passphrase</label>
            </div>
          </div>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="remember-passphrase" checked>
            <label class="form-check-label muted" for="remember-passphrase">Remember this passphrase on this device</label>
          </div>

          <input type="hidden" name="client_hash">
        </div>

        <button class="btn btn-primary btn-lg w-100" type="submit">Register</button>

        <div class="muted small">
          ‚ö†Ô∏è If you clear browser storage or switch devices, you‚Äôll need to type your passphrase or request a reset.
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("register-form");

  const modeRadios = Array.from(form.querySelectorAll('input[name="phrase_mode"]'));
  const generatedWrap = document.getElementById("generated-wrap");
  const manualWrap = document.getElementById("manual-wrap");

  const phraseBox = document.getElementById("reg-passphrase");
  const regenBtn = document.getElementById("btn-new-passphrase");

  const manualInput = document.getElementById("manual-passphrase");
  const showManual = document.getElementById("show-manual");
  const remember = document.getElementById("remember-passphrase");

  let currentPhrase = "";

  function refreshPhrase() {
    currentPhrase = generatePassphrase(6);
    phraseBox.textContent = currentPhrase;
  }

  function currentMode() {
    return (modeRadios.find(r => r.checked)?.value) || "generated";
  }

  function syncModeUI() {
    const m = currentMode();
    const gen = (m === "generated");
    generatedWrap.style.display = gen ? "" : "none";
    manualWrap.style.display = gen ? "none" : "";
  }

  // init
  refreshPhrase();
  syncModeUI();

  regenBtn.addEventListener("click", refreshPhrase);
  modeRadios.forEach(r => r.addEventListener("change", syncModeUI));

  showManual.addEventListener("change", () => {
    manualInput.type = showManual.checked ? "text" : "password";
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = (form.elements["name"]?.value || "").trim();
    if (!name) { alert("Name is required."); return; }

    let phrase = "";
    if (currentMode() === "manual") {
      phrase = (manualInput.value || "").trim();
      if (!phrase) { alert("Please enter a passphrase."); return; }
    } else {
      phrase = currentPhrase;
    }

    if (remember.checked) {
      localStorage.setItem(keyForName(name), phrase);
    } else {
      localStorage.removeItem(keyForName(name));
    }

    form.elements["client_hash"].value = await sha256Hex(phrase);
    form.submit();
  });
});
</script>
{% endblock %}

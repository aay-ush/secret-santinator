{% extends "base.html" %}

{% block content %}
<h1>Register</h1>

<form id="register-form" method="post">
  <label>
    Name:
    <input type="text" name="name" required>
  </label>
  <br><br>

  <label>
    Email (optional):
    <input type="email" name="email">
  </label>
  <br><br>

  <p><strong>Your generated passphrase:</strong></p>

  <!-- Visible passphrase -->
  <div
    id="reg-passphrase"
    style="
      font-weight: bold;
      font-size: 1.2em;
      padding: 8px;
      background: #f4f4f4;
      display: inline-block;
      margin-bottom: 8px;
    ">
  </div>
  <br>

  <button type="button" id="btn-new-passphrase">
    Give me another
  </button>

  <input type="hidden" name="client_hash">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <br><br>

  <button type="submit">
    Use this passphrase & Register
  </button>
</form>

<p style="margin-top:1em;">
  ⚠️ This passphrase is stored only on this device.
  If you clear browser storage or switch devices, you will need an admin reset.
</p>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("register-form");
  const phraseBox = document.getElementById("reg-passphrase");
  const regenBtn = document.getElementById("btn-new-passphrase");

  let currentPhrase = "";

  function refreshPhrase() {
    currentPhrase = generatePassphrase(6);
    phraseBox.textContent = currentPhrase;
  }

  // Show phrase immediately
  refreshPhrase();

  regenBtn.addEventListener("click", refreshPhrase);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // ✅ Robust: read by name attribute from THIS form
    const name = (form.elements["name"]?.value || "").trim();

    if (!name) {
      alert("Name is required.");
      return;
    }

    // Store passphrase locally (client remembers)
    localStorage.setItem(keyForName(name), currentPhrase);

    // Send only SHA-256(passphrase) to server
    form.elements["client_hash"].value = await sha256Hex(currentPhrase);

    form.submit();
  });
});
</script>
{% endblock %}

